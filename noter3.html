<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes & Snippets Manager</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- highlight.js for syntax highlighting -->
    <!-- UPDATED: Added both dark and light themes for highlight.js -->
    <link id="hljs-dark-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link id="hljs-light-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css" disabled>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- NEW: TinyMCE Rich Text Editor -->
    <script src="https://cdn.tiny.cloud/1/z2cp8qdc030rut9lz5e8moaw2l69t5do7e667jysbqbcgfkn/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        /* --- Custom Styles & UI Enhancements --- */
        :root {
            --bg-light: #f9fafb; --text-light: #111827; --border-light: #e5e7eb; --card-light: #ffffff; --muted-light: #6b7280; --primary: #3b82f6; --primary-foreground: #ffffff;
            --bg-dark: #111827; --text-dark: #f9fafb; --border-dark: #374151; --card-dark: #1f2937; --muted-dark: #9ca3af;
        }
        html { scroll-behavior: smooth; }
        body { transition: background-color 0.3s ease, color 0.3s ease; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .btn-icon { display: inline-flex; align-items: center; justify-content: center; border-radius: 0.5rem; width: 2.25rem; height: 2.25rem; }
        .btn-icon:hover { background-color: rgba(128, 128, 128, 0.1); }
        .btn-icon:active { transform: scale(0.95); }
        
        /* Satisfying Input Field with Floating Label */
        .form-group { position: relative; margin-top: 1.5rem; }
        .form-input {
            width: 100%; padding: 12px 10px 8px 10px; border: 1px solid; border-radius: 8px; font-size: 1rem;
            background-color: transparent; transition: border-color 0.2s;
            border-color: var(--border-light);
        }
        .dark .form-input { border-color: var(--border-dark); }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .form-label {
            position: absolute; left: 10px; top: 10px; font-size: 1rem; color: var(--muted-light);
            pointer-events: none; transition: all 0.2s ease; background-color: var(--card-light); padding: 0 5px;
        }
        .dark .form-label { color: var(--muted-dark); background-color: #1f2937; /* Same as main content panel bg */ }
        .form-input:focus ~ .form-label, .form-input:not(:placeholder-shown) ~ .form-label {
            top: -10px; left: 10px; font-size: 0.75rem; color: var(--primary);
        }
        .form-textarea { min-height: 24rem; font-family: 'SF Mono', 'Fira Code', 'Fira Mono', 'Roboto Mono', monospace; line-height: 1.6; }

        /* Custom Modal */
        #modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 40; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #modal-container { position: fixed; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0.95); transition: opacity 0.3s, transform 0.3s; pointer-events: none; }
        #modal-backdrop.active, #modal-container.active { opacity: 1; transform: scale(1); pointer-events: auto; }

        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 10000; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast {
            padding: 1rem 1.5rem; border-radius: 0.5rem; color: white;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -4px rgba(0,0,0,.1);
            transform: translateX(120%); opacity: 0;
            animation: slideIn 0.5s forwards, fadeOut 0.5s 3.5s forwards;
        }
        .toast.success { background-color: #10b981; } .toast.error { background-color: #ef4444; }
        @keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(120%); } }

        /* --- UPDATED: TinyMCE UI Tweaks --- */
        .tox-tinymce { border-radius: 0.5rem !important; }
    </style>
</head>
<body class="text-gray-900 bg-gray-50 dark:bg-gray-900 dark:text-gray-100">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col transition-all">
            <!-- Header -->
            <div class="p-5 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-xl font-bold">Notes & Snippets</h1>
                    <button id="theme-toggle-btn" class="btn-icon"></button>
                </div>
                
                <div class="relative">
                    <div id="search-icon" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></div>
                    <input id="search-input" type="text" placeholder="Search..." class="w-full pl-10 pr-8 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                    <button id="clear-search-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hidden"></button>
                </div>
            </div>

            <!-- Categories -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-sm font-semibold uppercase text-gray-500 dark:text-gray-400">Categories</h2>
                    <button id="show-category-form-btn" class="btn-icon text-gray-500 dark:text-gray-400"></button>
                </div>
                
                <div id="category-list" class="space-y-1"></div>
                
                <div id="new-category-form" class="hidden mt-2 p-3 border border-gray-200 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                    <input id="new-category-name" type="text" placeholder="New category name" class="w-full mb-2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-transparent focus:ring-2 focus:ring-blue-500 outline-none">
                    <div class="flex gap-2">
                        <button id="add-category-btn" class="w-full px-3 py-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">Add</button>
                        <button id="cancel-category-btn" class="w-full px-3 py-1.5 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Notes List -->
            <div class="flex-1 overflow-y-auto">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h2 id="notes-list-header" class="text-sm font-semibold text-gray-600 dark:text-gray-300">All Items</h2>
                        <button id="new-note-btn" class="btn-icon text-gray-500 dark:text-gray-400"></button>
                    </div>
                    <div id="notes-list" class="space-y-2"></div>
                </div>
            </div>

            <!-- Import/Export Footer -->
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex gap-2">
                    <button id="export-btn" class="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <span id="download-icon"></span> Export
                    </button>
                    <label class="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors cursor-pointer">
                        <span id="upload-icon"></span> Import
                        <input id="import-input" type="file" accept=".json" class="hidden">
                    </label>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-gray-100 dark:bg-gray-900/50 transition-all">
            <!-- Editor Header -->
            <header id="editor-header" class="p-5 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex items-center justify-between">
                <h2 id="editor-title" class="text-lg font-semibold">New Item</h2>
                <div id="editor-actions" class="flex items-center gap-1"></div>
            </header>

            <!-- HERE IS THE INPUT FIELD AREA. ALWAYS VISIBLE. -->
            <div id="editor-container" class="flex-1 p-6 overflow-y-auto bg-white dark:bg-gray-800">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="note-type-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Type</label>
                            <select id="note-type-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                <option value="note">Note</option>
                                <option value="snippet">Code Snippet</option>
                            </select>
                        </div>
                        <div>
                            <label for="note-category-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
                            <select id="note-category-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-blue-500 focus:border-blue-500 outline-none"></select>
                        </div>
                        <div id="language-select-container" class="hidden">
                            <label for="language-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Language</label>
                            <select id="language-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-blue-500 focus:border-blue-500 outline-none">
                                <option value="javascript">JavaScript</option><option value="python">Python</option><option value="html">HTML</option><option value="css">CSS</option><option value="sql">SQL</option><option value="bash">Bash</option><option value="json">JSON</option><option value="plaintext">Plain Text</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <input id="title-input" type="text" placeholder=" " class="form-input" />
                        <label for="title-input" class="form-label">Title</label>
                    </div>

                    <!-- UPDATED: Content area now holds both the new rich text editor and the old textarea -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Content</label>
                        <!-- Rich Text Editor for Notes -->
                        <div id="wysiwyg-editor-container">
                            <textarea id="content-editor"></textarea>
                        </div>
                        <!-- Plain Textarea for Snippets -->
                        <div id="code-editor-container" class="hidden">
                             <textarea id="content-textarea" placeholder="Enter your code snippet here..." class="form-input form-textarea"></textarea>
                        </div>
                    </div>

                    <div id="snippet-preview-container" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Preview</label>
                        <!-- UPDATED: Background now changes with theme -->
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg overflow-auto max-h-96">
                            <pre><code id="snippet-preview" class="hljs p-4 text-sm"></code></pre>
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button id="save-btn" class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed transition-all transform active:scale-95">Save</button>
                        <button id="cancel-edit-btn" class="hidden px-5 py-2.5 bg-gray-200 dark:bg-gray-600 font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-all transform active:scale-95">Cancel</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Custom Modal -->
    <div id="modal-backdrop"></div>
    <div id="modal-container">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 id="modal-title" class="text-lg font-bold">Confirm Action</h3>
            <p id="modal-message" class="mt-2 text-sm text-gray-600 dark:text-gray-300">Are you sure?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications Container -->
    <div id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- ICON DEFINITIONS (SVG) ---
    const ICONS = {
        search: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`,
        plus: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
        trash2: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
        pin: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><path d="M16 12V4a4 4 0 0 0-4-4H4a4 4 0 0 0-4 4v8a4 4 0 0 0 4 4h2v4l3-3 3 3v-4h2a4 4 0 0 0 4-4z"/></svg>`,
        pinOff: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="2" x2="22" y1="2" y2="22"/><line x1="12" y1="12" x2="12" y2="12"/><path d="M16 12V4a4 4 0 0 0-4-4H4a4 4 0 0 0-4 4v8a4 4 0 0 0 4 4h2v4l3-3 3 3v-4h2a4 4 0 0 0 4-4z"/></svg>`,
        moon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
        sun: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
        download: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
        upload: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>`,
        code: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>`,
        fileText: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
        x: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
    };

    // --- STATE MANAGEMENT ---
    let state = {
        notes: [],
        categories: [
            { id: '1', name: 'Work', color: '#3B82F6' },
            { id: '2', name: 'Personal', color: '#10B981' },
            { id: '3', name: 'Ideas', color: '#8B5CF6' },
            { id: '4', name: 'Code', color: '#F59E0B' }
        ],
        selectedCategory: 'all',
        searchTerm: '',
        isEditing: false,
        editingNoteId: null,
        isDarkMode: false,
        showNewCategoryForm: false,
    };
    
    // --- DOM ELEMENT REFERENCES ---
    const dom = {
        themeToggleBtn: document.getElementById('theme-toggle-btn'),
        searchInput: document.getElementById('search-input'),
        searchIcon: document.getElementById('search-icon'),
        clearSearchBtn: document.getElementById('clear-search-btn'),
        categoryList: document.getElementById('category-list'),
        notesList: document.getElementById('notes-list'),
        notesListHeader: document.getElementById('notes-list-header'),
        showCategoryFormBtn: document.getElementById('show-category-form-btn'),
        newCategoryForm: document.getElementById('new-category-form'),
        newCategoryNameInput: document.getElementById('new-category-name'),
        addCategoryBtn: document.getElementById('add-category-btn'),
        cancelCategoryBtn: document.getElementById('cancel-category-btn'),
        newNoteBtn: document.getElementById('new-note-btn'),
        exportBtn: document.getElementById('export-btn'),
        importInput: document.getElementById('import-input'),
        editorContainer: document.getElementById('editor-container'),
        editorHeader: document.getElementById('editor-header'),
        editorTitle: document.getElementById('editor-title'),
        editorActions: document.getElementById('editor-actions'),
        noteTypeSelect: document.getElementById('note-type-select'),
        noteCategorySelect: document.getElementById('note-category-select'),
        languageSelectContainer: document.getElementById('language-select-container'),
        languageSelect: document.getElementById('language-select'),
        titleInput: document.getElementById('title-input'),
        wysiwygEditorContainer: document.getElementById('wysiwyg-editor-container'),
        codeEditorContainer: document.getElementById('code-editor-container'),
        contentTextArea: document.getElementById('content-textarea'), // For snippets
        snippetPreviewContainer: document.getElementById('snippet-preview-container'),
        snippetPreview: document.getElementById('snippet-preview'),
        saveBtn: document.getElementById('save-btn'),
        cancelEditBtn: document.getElementById('cancel-edit-btn'),
        // UPDATED: Added theme stylesheets
        hljsDarkTheme: document.getElementById('hljs-dark-theme'),
        hljsLightTheme: document.getElementById('hljs-light-theme'),
        modal: {
            backdrop: document.getElementById('modal-backdrop'),
            container: document.getElementById('modal-container'),
            title: document.getElementById('modal-title'),
            message: document.getElementById('modal-message'),
            cancelBtn: document.getElementById('modal-cancel-btn'),
            confirmBtn: document.getElementById('modal-confirm-btn'),
        }
    };

    // --- HELPER & UTILITY FUNCTIONS ---
    
    const showToast = (message, type = 'success') => {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    };
    
    const showModal = (title, message, onConfirm) => {
        dom.modal.title.textContent = title;
        dom.modal.message.textContent = message;
        dom.modal.backdrop.classList.add('active');
        dom.modal.container.classList.add('active');
        const confirmHandler = () => { onConfirm(); hideModal(); };
        const cancelHandler = () => { hideModal(); };
        dom.modal.confirmBtn.onclick = confirmHandler;
        dom.modal.cancelBtn.onclick = cancelHandler;
        dom.modal.backdrop.onclick = cancelHandler;
    };
    
    const hideModal = () => {
        dom.modal.backdrop.classList.remove('active');
        dom.modal.container.classList.remove('active');
        dom.modal.confirmBtn.onclick = null;
        dom.modal.cancelBtn.onclick = null;
        dom.modal.backdrop.onclick = null;
    };

    const getCategory = (id) => state.categories.find(c => c.id === id) || { name: 'Uncategorized', color: '#6B7280' };

    // --- DATA PERSISTENCE (LocalStorage) ---

    const saveData = () => {
        localStorage.setItem('notes-app-notes', JSON.stringify(state.notes));
        localStorage.setItem('notes-app-categories', JSON.stringify(state.categories));
        localStorage.setItem('notes-app-theme', state.isDarkMode ? 'dark' : 'light');
    };

    const loadData = () => {
        const savedNotes = localStorage.getItem('notes-app-notes');
        const savedCategories = localStorage.getItem('notes-app-categories');
        const savedTheme = localStorage.getItem('notes-app-theme');
        if (savedNotes) state.notes = JSON.parse(savedNotes).map(note => ({ ...note, createdAt: new Date(note.createdAt), updatedAt: new Date(note.updatedAt) }));
        if (savedCategories) state.categories = JSON.parse(savedCategories);
        state.isDarkMode = savedTheme === 'dark';
    };
    
    // --- RENDER FUNCTIONS ---
    
    const applyTheme = () => {
        // Explicitly toggle 'light' and 'dark' classes on the root element
        document.documentElement.classList.toggle('dark', state.isDarkMode);
        document.documentElement.classList.toggle('light', !state.isDarkMode);

        if (state.isDarkMode) {
            dom.themeToggleBtn.innerHTML = ICONS.sun;
        } else {
            dom.themeToggleBtn.innerHTML = ICONS.moon;
        }

        // Switch highlight.js theme stylesheet
        dom.hljsDarkTheme.disabled = !state.isDarkMode;
        dom.hljsLightTheme.disabled = state.isDarkMode;

        // Re-initialize TinyMCE editor with the correct theme
        const activeEditor = tinymce.get('content-editor');
        if (activeEditor) activeEditor.remove();
        initTinyMCE(state.isDarkMode);
    };

    const renderCategories = () => {
        dom.categoryList.innerHTML = '';
        const allNotesButton = document.createElement('button');
        allNotesButton.className = `w-full text-left px-3 py-2 rounded-lg text-sm transition-colors ${state.selectedCategory === 'all' ? 'bg-blue-500 text-white' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;
        allNotesButton.innerHTML = `All Notes (${state.notes.length})`;
        allNotesButton.onclick = () => { state.selectedCategory = 'all'; renderCategories(); renderNotesList(); };
        dom.categoryList.appendChild(allNotesButton);

        state.categories.forEach(category => {
            const count = state.notes.filter(note => note.category === category.id).length;
            const button = document.createElement('button');
            button.className = `w-full text-left px-3 py-2 rounded-lg text-sm transition-colors flex items-center gap-2 ${state.selectedCategory === category.id ? 'bg-blue-500 text-white' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;
            button.innerHTML = `<div class="w-3 h-3 rounded-full" style="background-color: ${category.color}"></div><span class="flex-1">${category.name}</span><span>(${count})</span>`;
            button.onclick = () => { state.selectedCategory = category.id; renderCategories(); renderNotesList(); };
            dom.categoryList.appendChild(button);
        });

        dom.noteCategorySelect.innerHTML = state.categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
    };
    
    const renderNotesList = () => {
        const filteredNotes = getFilteredNotes();
        dom.notesList.innerHTML = '';
        
        const currentCategory = state.selectedCategory === 'all' ? {name: 'All Items'} : getCategory(state.selectedCategory);
        dom.notesListHeader.textContent = `${currentCategory.name} (${filteredNotes.length})`;

        if (filteredNotes.length === 0) {
            dom.notesList.innerHTML = `<div class="text-center py-8 text-gray-500 dark:text-gray-400 text-sm">${state.searchTerm ? 'No items match your search.' : 'No items in this category.'}</div>`;
            return;
        }
        
        filteredNotes.forEach(note => {
            const div = document.createElement('div');
            const category = getCategory(note.category);
            div.className = `p-3 rounded-lg cursor-pointer transition-colors border ${state.editingNoteId === note.id ? 'bg-blue-500/10 border-blue-500' : 'bg-gray-50 dark:bg-gray-700/50 border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600'}`;
            div.onclick = () => handleEdit(note.id);
            
            // For notes, strip HTML for preview. For snippets, escape it.
            let contentPreview = '';
            if (note.type === 'note') {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = note.content;
                contentPreview = tempDiv.textContent || tempDiv.innerText || "";
            } else {
                contentPreview = note.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }

            div.innerHTML = `
                <div class="flex items-start justify-between mb-1">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span class="${note.type === 'snippet' ? 'text-orange-500' : 'text-blue-500'}">${note.type === 'snippet' ? ICONS.code : ICONS.fileText}</span>
                        <span class="text-sm font-medium truncate">${note.title}</span>
                    </div>
                    ${note.isPinned ? `<span class="text-yellow-500">${ICONS.pin}</span>` : ''}
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 truncate mb-2">${contentPreview}</p>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full" style="background-color: ${category.color}"></div>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${category.name}</span>
                    </div>
                    <span class="text-xs text-gray-500 dark:text-gray-400">${note.updatedAt.toLocaleDateString()}</span>
                </div>`;
            dom.notesList.appendChild(div);
        });
    };

    const renderEditor = () => {
        const note = state.notes.find(n => n.id === state.editingNoteId);
        
        dom.editorTitle.textContent = (state.isEditing && note) ? 'Edit Item' : 'New Item';
        dom.titleInput.value = note ? note.title : '';
        dom.noteTypeSelect.value = note ? note.type : 'note';
        dom.noteCategorySelect.value = note ? note.category : (state.categories[0]?.id || '');
        dom.languageSelect.value = note?.language || 'javascript';
        
        // UPDATED: Set content based on note type
        if (note?.type === 'snippet') {
            dom.contentTextArea.value = note.content;
        } else {
            tinymce.get('content-editor')?.setContent(note?.content || '');
        }

        document.querySelectorAll('.form-input').forEach(input => input.dispatchEvent(new Event('input')));
        updateEditorUI();
        updateEditorActions();
        setTimeout(updateSaveButtonState, 100); // Allow editor time to update
    };

    const updateEditorUI = () => {
        const noteType = dom.noteTypeSelect.value;
        const isSnippet = noteType === 'snippet';
        
        dom.languageSelectContainer.classList.toggle('hidden', !isSnippet);
        dom.snippetPreviewContainer.classList.toggle('hidden', !isSnippet);
        dom.codeEditorContainer.classList.toggle('hidden', !isSnippet);
        dom.wysiwygEditorContainer.classList.toggle('hidden', isSnippet);

        if (isSnippet) {
             updateSnippetPreview();
        }
    };
    
    const updateSnippetPreview = () => {
        const code = dom.contentTextArea.value;
        const language = dom.languageSelect.value;
        if (code && language) {
            try { dom.snippetPreview.innerHTML = hljs.highlight(code, { language, ignoreIllegals: true }).value; } 
            catch (e) { dom.snippetPreview.textContent = code; }
        } else {
            dom.snippetPreview.innerHTML = '';
        }
    };

    const updateEditorActions = () => {
        dom.editorActions.innerHTML = '';
        const note = state.notes.find(n => n.id === state.editingNoteId);

        if (state.isEditing && note) {
            const createButton = (icon, title, colorClass, onClick) => {
                const btn = document.createElement('button');
                btn.className = `btn-icon ${colorClass || 'text-gray-500 dark:text-gray-400'}`;
                btn.innerHTML = icon; btn.title = title; btn.onclick = onClick;
                return btn;
            };
            const pinBtn = createButton(note.isPinned ? ICONS.pinOff : ICONS.pin, note.isPinned ? 'Unpin' : 'Pin', 'text-yellow-500', () => handlePin(note.id));
            const deleteBtn = createButton(ICONS.trash2, 'Delete', 'text-red-500', () => handleDelete(note.id));
            dom.editorActions.append(pinBtn, deleteBtn);
        }
    };
    
    const updateSaveButtonState = () => {
        const title = dom.titleInput.value.trim();
        let content = '';
        if (dom.noteTypeSelect.value === 'snippet') {
            content = dom.contentTextArea.value.trim();
        } else {
            const editor = tinymce.get('content-editor');
            if (editor) {
                content = editor.getContent({ format: 'text' }).trim();
            }
        }
        dom.saveBtn.disabled = !title || !content;
    };
    
    // --- EVENT HANDLERS & LOGIC ---

    const getFilteredNotes = () => {
        let filtered = state.notes;
        if (state.selectedCategory !== 'all') {
            filtered = filtered.filter(note => note.category === state.selectedCategory);
        }
        if (state.searchTerm) {
            const term = state.searchTerm.toLowerCase();
            filtered = filtered.filter(note => {
                const contentText = note.type === 'note' 
                    ? (new DOMParser().parseFromString(note.content, "text/html")).documentElement.textContent 
                    : note.content;
                return note.title.toLowerCase().includes(term) || contentText.toLowerCase().includes(term);
            });
        }
        return filtered.sort((a, b) => (a.isPinned !== b.isPinned) ? (a.isPinned ? -1 : 1) : (b.updatedAt.getTime() - a.updatedAt.getTime()));
    };

    const resetFormToNew = () => {
        state.isEditing = false;
        state.editingNoteId = null;
        dom.cancelEditBtn.classList.add('hidden');
        renderEditor();
        renderNotesList();
        dom.titleInput.focus();
    };

    const handleSave = () => {
        const title = dom.titleInput.value.trim();
        const type = dom.noteTypeSelect.value;
        let content;

        if (type === 'snippet') {
            content = dom.contentTextArea.value.trim();
        } else {
            content = tinymce.get('content-editor').getContent();
        }

        if (!title || !content) return;

        const now = new Date();
        const noteData = {
            title, content, category: dom.noteCategorySelect.value, type,
            language: type === 'snippet' ? dom.languageSelect.value : undefined, updatedAt: now,
        };

        if (state.isEditing && state.editingNoteId) {
            state.notes = state.notes.map(note => note.id === state.editingNoteId ? { ...note, ...noteData } : note);
            showToast('Item updated successfully!');
        } else {
            const newNote = { id: Date.now().toString(), ...noteData, isPinned: false, createdAt: now };
            state.notes.unshift(newNote);
            state.editingNoteId = newNote.id;
            state.isEditing = true;
            dom.cancelEditBtn.classList.remove('hidden');
            showToast('Item saved successfully!');
        }
        saveData();
        renderEditor();
        renderNotesList();
        renderCategories();
    };
    
    const handleEdit = (id) => {
        state.isEditing = true;
        state.editingNoteId = id;
        dom.cancelEditBtn.classList.remove('hidden');
        renderEditor();
        renderNotesList();
        dom.titleInput.focus();
    };

    const handleDelete = (id) => {
        showModal('Delete Item', 'Are you sure you want to permanently delete this item?', () => {
            state.notes = state.notes.filter(note => note.id !== id);
            if (state.editingNoteId === id) resetFormToNew();
            saveData();
            renderNotesList();
            renderCategories();
            showToast('Item deleted.', 'success');
        });
    };

    const handlePin = (id) => {
        state.notes = state.notes.map(note => note.id === id ? { ...note, isPinned: !note.isPinned } : note);
        saveData();
        renderNotesList();
        updateEditorActions();
    };
    
    const addCategory = () => {
        const name = dom.newCategoryNameInput.value.trim();
        if (!name) return;
        const colors = ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#EF4444', '#06B6D4'];
        state.categories.push({ id: Date.now().toString(), name: name, color: colors[Math.floor(Math.random() * colors.length)] });
        dom.newCategoryNameInput.value = '';
        state.showNewCategoryForm = false;
        dom.newCategoryForm.classList.add('hidden');
        saveData();
        renderCategories();
        showToast('Category added!');
    };
    
    const exportData = () => {
        const data = { notes: state.notes, categories: state.categories };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `notes-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('Data exported.');
    };

    const importData = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (data.notes && Array.isArray(data.notes)) state.notes = data.notes.map(note => ({ ...note, createdAt: new Date(note.createdAt), updatedAt: new Date(note.updatedAt) }));
                if (data.categories && Array.isArray(data.categories)) state.categories = data.categories;
                saveData();
                renderCategories();
                renderNotesList();
                showToast('Data imported successfully!');
            } catch (error) { showToast('Error importing data. Check file format.', 'error'); }
        };
        reader.readText(file);
        event.target.value = '';
    };

    // --- NEW: Initialize TinyMCE Editor ---
    const initTinyMCE = (isDark) => {
        tinymce.init({
            selector: '#content-editor',
            plugins: 'preview importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen image link media template codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons',
            menubar: 'file edit view insert format tools table help',
            toolbar: 'undo redo | bold italic underline strikethrough | fontfamily fontsize blocks | alignleft aligncenter alignright alignjustify | outdent indent |  numlist bullist | forecolor backcolor removeformat | pagebreak | charmap emoticons | fullscreen  preview save print | insertfile image media template link anchor codesample | ltr rtl',
            height: '24rem',
            autosave_ask_before_unload: true,
            skin: isDark ? 'oxide-dark' : 'oxide',
            content_css: isDark ? 'dark' : 'default',
            setup: (editor) => {
                editor.on('input', updateSaveButtonState);
                editor.on('change', updateSaveButtonState);
            }
        });
    };

    // --- EVENT LISTENER SETUP ---
    dom.themeToggleBtn.addEventListener('click', () => { state.isDarkMode = !state.isDarkMode; saveData(); applyTheme(); });
    dom.searchInput.addEventListener('input', (e) => { state.searchTerm = e.target.value; dom.clearSearchBtn.classList.toggle('hidden', !state.searchTerm); renderNotesList(); });
    dom.clearSearchBtn.addEventListener('click', () => { dom.searchInput.value = ''; state.searchTerm = ''; dom.clearSearchBtn.classList.add('hidden'); renderNotesList(); });
    dom.showCategoryFormBtn.addEventListener('click', () => { state.showNewCategoryForm = !state.showNewCategoryForm; dom.newCategoryForm.classList.toggle('hidden'); if(state.showNewCategoryForm) dom.newCategoryNameInput.focus(); });
    dom.addCategoryBtn.addEventListener('click', addCategory);
    dom.newCategoryNameInput.addEventListener('keypress', (e) => e.key === 'Enter' && addCategory());
    dom.cancelCategoryBtn.addEventListener('click', () => { state.showNewCategoryForm = false; dom.newCategoryForm.classList.add('hidden'); dom.newCategoryNameInput.value = ''; });
    dom.newNoteBtn.addEventListener('click', resetFormToNew);
    dom.saveBtn.addEventListener('click', handleSave);
    dom.cancelEditBtn.addEventListener('click', resetFormToNew);
    dom.exportBtn.addEventListener('click', exportData);
    dom.importInput.addEventListener('change', importData);
    dom.noteTypeSelect.addEventListener('change', updateEditorUI);
    dom.languageSelect.addEventListener('change', updateSnippetPreview);
    dom.titleInput.addEventListener('input', updateSaveButtonState);
    dom.contentTextArea.addEventListener('input', () => { updateSaveButtonState(); if (dom.noteTypeSelect.value === 'snippet') updateSnippetPreview(); });
    document.querySelectorAll('.form-input').forEach(input => input.addEventListener('input', () => input.setAttribute('placeholder', ' ')));
    
    // --- NEW: Add Ctrl+S shortcut to save ---
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault(); // Prevent browser's save dialog
            if (!dom.saveBtn.disabled) {
                handleSave();
            }
        }
    });

    // --- INITIALIZATION ---
    const init = () => {
        dom.searchIcon.innerHTML = ICONS.search;
        dom.clearSearchBtn.innerHTML = ICONS.x;
        dom.showCategoryFormBtn.innerHTML = ICONS.plus;
        dom.newNoteBtn.innerHTML = ICONS.plus;
        dom.exportBtn.querySelector('#download-icon').innerHTML = ICONS.download;
        dom.importInput.parentElement.querySelector('#upload-icon').innerHTML = ICONS.upload;
        
        loadData();
        applyTheme(); // This will also initialize TinyMCE for the first time
        renderCategories();
        renderNotesList();
        resetFormToNew(); // Ensures the form is in 'new note' state on load
    };

    init();
});
</script>
</body>
</html>
