<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyglot Notebook - Robust Edition</title>
    
    <!-- CSS Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        editor: '#1e1e1e',
                        panel: '#252526',
                        accent: '#007acc',
                        text: '#cccccc'
                    }
                }
            }
        }
    </script>

    <!-- React Core -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.2/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/vs2015.min.css">
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

    <!-- Monaco Editor (Loader only) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>

    <style>
        body { background-color: #1e1e1e; color: #cccccc; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* Native Loading Screen */
        #loader { position: fixed; inset: 0; background: #1e1e1e; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: #007acc; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* App Styles */
        .markdown-body { padding: 40px; font-size: 16px; line-height: 1.6; color: #d4d4d4; }
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #333; padding-bottom: 10px; color: #fff; margin-top: 24px; }
        .markdown-body pre { background: #111; padding: 16px; border-radius: 6px; overflow-x: auto; }
        .markdown-body code { font-family: 'Consolas', monospace; background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px; }
        .markdown-body pre code { background: transparent; padding: 0; }
        .markdown-body blockquote { border-left: 4px solid #007acc; padding-left: 16px; color: #aaa; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .resizer { width: 5px; background: #333; cursor: col-resize; transition: 0.2s; z-index: 50; }
        .resizer:hover { background: #007acc; }

        .run-btn { position: absolute; top: 10px; right: 10px; background: #238636; border: none; color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; opacity: 0.7; transition: 0.2s; }
        .run-btn:hover { opacity: 1; transform: scale(1.05); }
        .code-wrap { position: relative; margin: 1em 0; }
    </style>
</head>
<body>
    
    <!-- Initial Loading Indicator -->
    <div id="loader">
        <div class="spinner"></div>
        <div id="loader-text">Initializing Environment...</div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect, useCallback } = React;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-10 text-red-500">
                            <h1 className="text-2xl font-bold mb-4">Application Crashed</h1>
                            <pre className="bg-black p-4 rounded border border-red-900">{this.state.error.toString()}</pre>
                            <button onClick={() => window.location.reload()} className="mt-4 px-4 py-2 bg-gray-800 rounded text-white">Reload</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- UTILS ---
        const executeCode = async (lang, code) => {
            window.dispatchEvent(new CustomEvent('console-log', { detail: { type: 'system', text: `> Running ${lang}...` } }));
            
            if (lang === 'js') {
                const log = console.log;
                const err = console.error;
                try {
                    console.log = (...args) => window.dispatchEvent(new CustomEvent('console-log', { detail: { type: 'log', text: args.join(' ') } }));
                    console.error = (...args) => window.dispatchEvent(new CustomEvent('console-log', { detail: { type: 'error', text: args.join(' ') } }));
                    const res = eval(code);
                    if (res !== undefined) console.log(res);
                } catch (e) { console.error(e.message); } 
                finally { console.log = log; console.error = err; }
            } else if (lang === 'py') {
                if (!window.pyodide) return window.dispatchEvent(new CustomEvent('console-log', { detail: { type: 'error', text: 'Python not ready yet.' } }));
                try { await window.pyodide.runPythonAsync(code); } 
                catch (e) { window.dispatchEvent(new CustomEvent('console-log', { detail: { type: 'error', text: e.message } })); }
            }
        };

        window.runSnippet = (lang, encoded) => executeCode(lang, decodeURIComponent(encoded));

        // --- MAIN APP ---
        const App = () => {
            const [markdown, setMarkdown] = useState("# Polyglot Notebook\n\nWrite Markdown, or try code blocks:\n\n```js\nconsole.log('Hello from JS!');\nconst x = 10;\nx * 2;\n```\n\n```py\nprint('Hello from Python!')\nimport numpy as np\narr = np.array([1, 2, 3])\narr * 2\n```");
            const [split, setSplit] = useState(50);
            const [logs, setLogs] = useState([]);
            const [pyStatus, setPyStatus] = useState('Init...');
            const [terminalOpen, setTerminalOpen] = useState(true);
            
            const editorRef = useRef(null); // Container
            const monacoInstance = useRef(null);
            const outputRef = useRef(null);

            // 1. Initialize Pyodide
            useEffect(() => {
                const loadPy = async () => {
                    try {
                        window.pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/" });
                        window.pyodide.setStdout({ batched: (t) => window.dispatchEvent(new CustomEvent('console-log', { detail: { type: 'log', text: t } })) });
                        window.pyodide.setStderr({ batched: (t) => window.dispatchEvent(new CustomEvent('console-log', { detail: { type: 'error', text: t } })) });
                        await window.pyodide.loadPackage("numpy");
                        setPyStatus('Ready');
                    } catch (e) { setPyStatus('Error'); }
                };
                loadPy();
                
                // Remove loader
                const loader = document.getElementById('loader');
                if(loader) loader.style.opacity = '0';
                setTimeout(() => loader?.remove(), 500);

                // Listen for logs
                const onLog = (e) => {
                    setLogs(prev => [...prev, e.detail]);
                    if (!terminalOpen) setTerminalOpen(true);
                };
                window.addEventListener('console-log', onLog);
                return () => window.removeEventListener('console-log', onLog);
            }, []);

            // 2. Initialize Monaco using RequireJS (Standard Way)
            useEffect(() => {
                require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
                require(['vs/editor/editor.main'], function() {
                    const editor = monaco.editor.create(document.getElementById('monaco-host'), {
                        value: markdown,
                        language: 'markdown',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        minimap: { enabled: false },
                        padding: { top: 20 },
                        fontSize: 14,
                        fontFamily: "Consolas, monospace"
                    });
                    
                    monacoInstance.current = editor;
                    
                    editor.onDidChangeModelContent(() => {
                        setMarkdown(editor.getValue());
                    });
                });

                return () => monacoInstance.current?.dispose();
            }, []);

            // 3. Markdown Parser Configuration
            const mdHtml = React.useMemo(() => {
                const md = window.markdownit({
                    html: true,
                    highlight: (str, lang) => {
                        if (lang && window.hljs.getLanguage(lang)) {
                            try { return window.hljs.highlight(str, { language: lang }).value; } catch (__) {}
                        }
                        return '';
                    }
                });
                
                // Override fence for run buttons
                md.renderer.rules.fence = (tokens, idx) => {
                    const token = tokens[idx];
                    const code = token.content.trim();
                    const lang = token.info.trim().split(/\s+/)[0];
                    let highlighted = code;
                    
                    if (lang && window.hljs.getLanguage(lang)) {
                        try { highlighted = window.hljs.highlight(code, { language: lang }).value; } catch (e) {}
                    }
                    
                    const isRunnable = ['js', 'javascript', 'py', 'python'].includes(lang);
                    const runBtn = isRunnable ? `<button class="run-btn" onclick="window.runSnippet('${lang.startsWith('py')?'py':'js'}', '${encodeURIComponent(code)}')">Run ▶</button>` : '';
                    
                    return `<div class="code-wrap">${runBtn}<pre class="hljs language-${lang}"><code>${highlighted}</code></pre></div>`;
                };

                return md.render(markdown);
            }, [markdown]);

            // 4. Resize Logic
            const startResize = useCallback((e) => {
                e.preventDefault();
                const onMove = (e) => setSplit(Math.min(80, Math.max(20, (e.clientX / window.innerWidth) * 100)));
                const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onUp);
            }, []);

            // 5. File System Logic (Safe)
            const saveFile = async () => {
                if (!window.showSaveFilePicker) return alert("Use Chrome/Edge for File Access");
                try {
                    const handle = await window.showSaveFilePicker({ suggestedName: 'notebook.md' });
                    const writable = await handle.createWritable();
                    await writable.write(markdown);
                    await writable.close();
                } catch(e) {}
            };

            const openFile = async () => {
                if (!window.showOpenFilePicker) return alert("Use Chrome/Edge for File Access");
                try {
                    const [handle] = await window.showOpenFilePicker();
                    const file = await handle.getFile();
                    const text = await file.text();
                    monacoInstance.current.setValue(text); // Updates state via listener
                } catch(e) {}
            };

            // Auto-scroll terminal
            useEffect(() => {
                if (outputRef.current) outputRef.current.scrollTop = outputRef.current.scrollHeight;
            }, [logs]);

            return (
                <div className="h-screen flex flex-col bg-editor text-text">
                    {/* Toolbar */}
                    <div className="h-12 bg-panel border-b border-black flex items-center justify-between px-4 shrink-0">
                        <div className="font-bold flex items-center gap-2">
                            <span className="text-accent text-xl">❖</span> Polyglot IDE
                        </div>
                        <div className="flex gap-2">
                            <div className={`text-xs flex items-center px-3 rounded ${pyStatus==='Ready'?'bg-green-900 text-green-200':'bg-yellow-900 text-yellow-200'}`}>
                                Python: {pyStatus}
                            </div>
                            <button onClick={openFile} className="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white">Open</button>
                            <button onClick={saveFile} className="px-3 py-1 bg-accent hover:bg-blue-600 rounded text-xs text-white">Save</button>
                        </div>
                    </div>

                    {/* Main Workspace */}
                    <div className="flex-1 flex overflow-hidden">
                        
                        {/* Editor Pane */}
                        <div style={{ width: `${split}%` }} className="relative flex flex-col">
                            <div id="monaco-host" className="flex-1 w-full h-full"></div>
                        </div>

                        {/* Resizer */}
                        <div className="resizer" onMouseDown={startResize}></div>

                        {/* Preview Pane */}
                        <div style={{ width: `${100 - split}%` }} className="flex flex-col bg-[#111]">
                            <div className="flex-1 overflow-y-auto markdown-body" dangerouslySetInnerHTML={{ __html: mdHtml }} />
                            
                            {/* Terminal */}
                            {terminalOpen && (
                                <div className="h-48 bg-black border-t border-gray-800 flex flex-col shrink-0">
                                    <div className="flex justify-between items-center px-2 py-1 bg-[#1e1e1e] border-b border-black">
                                        <span className="text-xs font-mono opacity-50">CONSOLE</span>
                                        <button onClick={() => setLogs([])} className="text-xs text-red-400 hover:text-red-300">Clear</button>
                                    </div>
                                    <div ref={outputRef} className="flex-1 overflow-y-auto p-2 font-mono text-sm">
                                        {logs.length === 0 && <span className="opacity-30 italic">Output will appear here...</span>}
                                        {logs.map((l, i) => (
                                            <div key={i} className={`mb-1 break-words ${l.type==='error'?'text-red-400':l.type==='system'?'text-blue-400':'text-green-400'}`}>
                                                {l.text}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
